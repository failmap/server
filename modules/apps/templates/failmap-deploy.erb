#!/bin/bash

set -xe

image="<%= @image %>"

# save current image as rollback
/usr/bin/docker tag "${image}" "${image/latest/rollback}"

# update current image
/usr/bin/docker pull "${image}"

# migrate database
/usr/local/bin/failmap-admin migrate

# restart all related services
systemctl restart docker-failmap-*.service
